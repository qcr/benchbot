#!/usr/bin/env bash

################################################################################
################### Load Helpers & Global BenchBot Settings ####################
################################################################################

set -euo pipefail
IFS=$'\n\t'
abs_path=$(readlink -f $0)
pushd $(dirname $abs_path) > /dev/null
source .helpers

################################################################################
########################### Script Specific Settings ###########################
################################################################################

# Hostnames
hostnames_block=\
"# BENCHBOT SPECIFIC HOSTNAMES
$URL_ROS $HOSTNAME_ROS
$URL_ROBOT $HOSTNAME_ROBOT
$URL_SUPERVISOR $HOSTNAME_SUPERVISOR
$URL_DEBUG $HOSTNAME_DEBUG"

# Defaults for the installation process
ADDONS_DEFAULT='benchbot-addons/ssu'
CUDA_DEFAULT='cuda'
NVIDIA_DEFAULT='nvidia-driver-455'
SIMULATOR_DEFAULT='sim_omni'

################################################################################
########################### Definitions for messages ###########################
################################################################################
usage_text="$(basename "$abs_path") -- Install script for the BenchBot software stack

USAGE:

    Install the software stack:
        $(basename "$abs_path") 

    Install from scratch, & skip check for the latest software stack:
        $(basename "$abs_path") --no-update [-f|--force-clean]

    Install the lite version of the backend (i.e. no simulator, ~10GB):
        $(basename "$abs_path") --no-simulator

    Uninstall the software stack:
        $(basename "$abs_path") [-u|--uninstall]

OPTION DETAILS:

    -h, --help
            Show this help menu.

    -a, --addons
            Comma separated list of add-ons to install. Add-ons exist in GitHub
            repositories, and are specified by their identifier:
            'username/repo_name'.  Add-on installation also installs all
            required add-on dependencies.  See add-on manager documentation for
            details:
              https://github.com/qcr/benchbot-addons

            Also see '--list-addons' for a details on installed add-ons, and a
            list of all known BenchBot add-ons.

    -A, --addons-only
            Only perform the installation of the specified add-ons. Skip all
            other steps in the install process, including Docker images and
            local software installation. This flag is useful if you just want
            to change add-ons inside your working installation.

    -b, --branch
            Specify a branch other than master to install. The only use for
            this flag is active development. The general user will never need
            to use this flag.

    -f, --force-clean
            Forces an install of the BenchBot software stack from scratch. It
            will run uninstall, then the full install process.

    --list-addons
            List all currently installed add-ons with their dependency
            structure noted. Also list all official add-ons available in the
            'benchbot-addons' GitHub organisation. If you would like to add a
            community contribution to the community list, please follow the
            instructions here:
              https://github.com/qcr/benchbot-addons

    --list-simulators
            List all supported simulators that can be installed. It will also
            show which simulators you currently have installed.

    --no-simulator
            Runs installation without installing Nvidia's Omniverse-based Isaac
            simulator.  This option is useful for avoiding the excessive space
            requirements (>100GB) when using the BenchBot software stack on a
            machine that will only be used with a real robot.

    --no-update
            Skip checking for updates to the BenchBot software stack, & instead
            jump straight into the installation process.

    --remove-addons
            Comma separated list of add-ons to remove (uses the same syntax as
            the '--addons' flag). This command will also remove any dependent
            add-ons as they will no longer work (e.g. if A depends on B, and
            B is uninstalled, then there is no reason for A to remain). You
            will be presented with a list of add-ons that will be removed, and
            prompted before removal commences.

    -s, --simulators
            Specify simulator/s to install. Comma-separated lists are accepted
            to specify multiple simulators. The default '$SIMULATOR_DEFAULT' is
            installed if this option isn't included. See '--list-simulators'
            for a list of supported options.

    -u, --uninstall
            Uninstall the BenchBot software stack from the machine. All BenchBot
            related Docker images will be removed from the system, the API 
            removed from pip, & downloaded files removed from the BenchBot
            install. This flag is incompatible with all other flags.

    -v, --version
            Print version info for current installation.

FURTHER DETAILS:
    
    Please contact the authors of BenchBot for support or to report bugs:
        b.talbot@qut.edu.au
    "

build_err="\
Ensure that Docker has been installed correctly AND that you can run Docker 
WITHOUT root access (there is no need to ever run Docker with root). See 
https://docs.docker.com/install/linux/linux-postinstall/ for details on how to 
fix this. 

If the error is more generic, please contact us so that we can update our
pre-install host system checks.
"

################################################################################
################### All checks for the host system (ouch...) ###################
################################################################################

checks_list_pre=(
  "Core host system checks:"
  "ubuntu1804"
  "Running Nvidia related system checks:"
  "nvidiacard"  # Is a valid graphics card available?
  "nvidiadriver"  # Is the driver available?
  "nvidiaversion"  # Is the driver version valid?
  "nvidiappa"  # Does the driver come from a supported PPA?
  "cudadriversavailable" # Is cuda-drivers package available?
  "cudadriversversion"  # Is cuda-drivers version valid?
  "cudadriversppa"  # Is cuda-drivers from the Nvidia PPA?
  "cudaavailable"  # Is CUDA available?
  "cudaversion"  # Is the cuda version valid?
  "cudappa"  # Is cuda from the Nvidia PPA?
  "Running Docker related system checks:"
  "dockeravailable"  # Is Docker available?
  "dockerversion"  # Is Docker version > 19.0?
  "dockernct"  # Is nvidia-container-toolkit installed?
  "dockerroot"  # Does Docker work WITHOUT root?
  "Running checks of filesystem used for Docker:"
  "fsext4"  # Is /var/lib/docker on an ext4 filesystem?
  "fsnosuid"  # Is /var/lib/docker on a filesystem WITHOUT nosuid?
  "fsspace"  # Is /var/lib/docker on a filesystem with enough space?
  "Miscellaneous requirements:"
  "pip" # Is pip available? (required to install Python libraries)
  "pythontk" # Is python-tk installed (required for matplotlib...)
  )

chk_ubuntu1804_name='Ubuntu version >= 18.04'
chk_ubuntu1804_pass='Passed ($check_result)'
chk_ubuntu1804_fail='Failed'
chk_ubuntu1804_check=\
'[ -f /tmp/benchbot_chk_ubuntu1804 ] && echo "skipped" || lsb_release -r | \
awk '"'"'{print $2}'"'"' 2>/dev/null'
chk_ubuntu1804_eval=\
'[ "$check_result" == "skipped" ] || eval_version "$check_result" "18.04"'
chk_ubuntu1804_issue="\
  The BenchBot Software Stack is designed to work with Ubuntu 18.04 & above.

  There is a possibility it may work with other versions, & other
  distributions, but it will probably involve manual installation of packages &
  installing missing tools.

  Given the complexity of the underlying system, it is strongly recommended to
  move to a supported operating system.

  If you would like to continue, & ignore this check, please say yes to the fix
  below.
  "
chk_ubuntu1804_fix='touch /tmp/benchbot_chk_ubuntu1804'
chk_ubuntu1804_reboot=1
  
chk_nvidiacard_name='Nvidia GPU available'
chk_nvidiacard_pass='Found card of type '"'"'$check_result'"'"
chk_nvidiacard_fail='None found'
chk_nvidiacard_check=\
'lspci -nn | grep -E "\[03.*\[10de:[0-9a-f]{4}\]" | \
sed -E '"'"'s/.*(10de:[0-9a-f]{4}).*/\1/'"'"' | head -n 1'
chk_nvidiacard_eval='[ -n "$check_result" ]'
chk_nvidiacard_issue="\
  No Nvidia Graphics Card was detected. If there is a card available on your 
  host system, then it should be visible in 'lspci -nn | grep VGA' with an ID
  of [10de:<product_id>]). For example, a GeForce 1080 appears as [10de:1b80]."
chk_nvidiacard_fix=''
chk_nvidiacard_reboot=0

chk_nvidiadriver_name='Nvidia driver is running'
chk_nvidiadriver_pass='Found' 
chk_nvidiadriver_fail='Not found'
chk_nvidiadriver_check='cat /proc/driver/nvidia/version 2>/dev/null'
chk_nvidiadriver_eval='[ -n "$check_result" ]'
chk_nvidiadriver_issue="\
  No Nvidia driver detected. If a driver is installed & loaded, it should be
  visible with 'nvidia-smi' or 'cat /proc/driver/nvidia/version'."
chk_nvidiadriver_fix=\
'v=$(. /etc/os-release; echo "$VERSION_ID" | sed "s/\.//") &&
wget "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu${v}/\
x86_64/cuda-ubuntu${v}.pin" &&
sudo mv cuda-ubuntu${v}.pin /etc/apt/preferences.d/cuda-repository-pin-600 &&
sudo apt-key adv --fetch-keys "https://developer.download.nvidia.com/compute/\
cuda/repos/ubuntu1804/x86_64/7fa2af80.pub" &&
sudo add-apt-repository "deb http://developer.download.nvidia.com/compute/\
cuda/repos/ubuntu${v}/x86_64/ /" &&
sudo apt-get update && sudo apt-get -y install '"$NVIDIA_DEFAULT"
chk_nvidiadriver_reboot=0

chk_nvidiaversion_name='Nvidia driver version valid'
chk_nvidiaversion_pass='Valid ($check_result)'
chk_nvidiaversion_fail='Invalid ($check_result)'
chk_nvidiaversion_check='cat /proc/driver/nvidia/version 2>/dev/null | '\
'sed '"'"'/NVRM version/!d; s/.*Kernel Module *\([0-9\.]*\).*/\1/'"'"
chk_nvidiaversion_eval='eval_version "$check_result" 418'
chk_nvidiaversion_issue="\
  The version of the running Nvidia driver ("'$check_result'") is incompatible
  with BenchBot which requires at least version 418 for the Isaac SDK.

  Please install a more recent version of the driver from the Nvidia repository."
chk_nvidiaversion_fix="$chk_nvidiadriver_fix"
chk_nvidiaversion_reboot=0

chk_nvidiappa_name='Nvidia driver from a standard PPA'
chk_nvidiappa_pass='PPA is valid'
chk_nvidiappa_fail='PPA is invalid'
chk_nvidiappa_check='version=$(apt list --installed 2>/dev/null | '\
'grep nvidia-driver- | sed '"'"'s/.*now \([^ ]*\).*/\1/'"'"'); '\
'apt download --print-uris nvidia-driver-$(echo $version | '\
'cut -d'"'"'.'"'"' -f1)=$version 2>/dev/null | cut -d'"'"' '"'"' -f1'
chk_nvidiappa_eval=\
'[[ "$check_result" =~ .*('"'"'developer.download.nvidia.com/'"'"'| \
'"'"'ppa.launchpad.net/graphics-drivers/ppa/ubuntu'"'"').* ]]'
chk_nvidiappa_issue="\
  The installed Nvidia driver was detected to have come from somewhere other
  than the Nvidia / Ubuntu graphics-drivers PPAs. The driver was sourced from:
    "'$check_result'"

  Our Docker container only supports official drivers, & GPUs only work in 
  containers if the driver version exactly matches the version of the host.
  Please use a driver from either of the following locations (the Nvidia PPA is
  preferred):
    http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64
    http://ppa.launchpad.net/graphics-drivers/ppa/ubuntu"
chk_nvidiappa_fix=\
'sudo apt remove -y nvidia-driver-* && sudo apt -y autoremove; '\
"$chk_nvidiadriver_fix"
chk_nvidiappa_reboot=0

chk_cudadriversavailable_name='CUDA drivers installed'
chk_cudadriversavailable_pass='Drivers found'
chk_cudadriversavailable_fail='Drivers not found'
chk_cudadriversavailable_check='apt list --installed 2>/dev/null | grep -E '\
'"cuda-drivers/" | awk '"'"'{print $2}'"'"
chk_cudadriversavailable_eval='[ -n "$check_result" ]'
chk_cudadriversavailable_issue="\
  No version of CUDA drivers detected. Our Docker only supports CUDA drivers 
  installations from the official Nvidia repository. Please add the Nvidia 
  repository, & install 'cuda-drivers' through apt."
chk_cudadriversavailable_fix=\
"${chk_nvidiadriver_fix//$NVIDIA_DEFAULT/cuda-drivers}"
chk_cudadriversavailable_reboot=1

chk_cudadriversversion_name='CUDA drivers version valid'
chk_cudadriversversion_pass='Valid ($check_result)'
chk_cudadriversversion_fail='Invalid'
chk_cudadriversversion_check='apt list --installed 2>/dev/null | grep -E '\
'"cuda-drivers/" | awk '"'"'{print $2}'"'"
chk_cudadriversversion_eval='eval_version "$check_result" 418'
chk_cudadriversversion_issue="\
  The version of CUDA drivers detected ("'$check_result'") is incompatible with 
  BenchBot which requires CUDA drivers 418+ for the Isaac SDK.

  Please install a more recent version of the CUDA drivers from the Nvidia 
  repository."
chk_cudadriversversion_fix=\
"${chk_nvidiadriver_fix//$NVIDIA_DEFAULT/cuda-drivers}"
chk_cudadriversversion_reboot=1

chk_cudadriversppa_name='CUDA drivers from the Nvidia PPA'
chk_cudadriversppa_pass='PPA is valid'
chk_cudadriversppa_fail='PPA is invalid'
chk_cudadriversppa_check=\
'installed=$(apt list --installed 2>/dev/null | grep -E "cuda-drivers/" | \
awk '"'"'{print $2}'"'"'); \
apt download --print-uris cuda-drivers=\
$(echo $installed | sed '"'"'s/.*now \([^ ]*\).*/\1/'"'"') 2>/dev/null | \
cut -d'"'"' '"'"' -f1'
chk_cudadriversppa_eval=\
'[[ "$check_result" =~ .*('"'"'developer.download.nvidia.com/'"'"').* ]]'
chk_cudadriversppa_issue="\
  CUDA drivers were detected to have come from somewhere other than the Nvidia 
  PPAs. The CUDA drivers were sourced from:
    "'$check_result'"

  Our Docker container only supports official CUDA installs, & GPUs only work
  in containers if the CUDA drivers version exactly matches the version of the
  host.  Please install CUDA drivers from the official Nvidia repository:
    http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64"
chk_cudadriversppa_fix=\
'sudo apt remove -y cuda-drivers && sudo apt -y autoremove; '\
"${chk_nvidiadriver_fix//$NVIDIA_DEFAULT/cuda-drivers}"
chk_cudadriversppa_reboot=1

chk_cudaavailable_name='CUDA is installed'
chk_cudaavailable_pass='CUDA found'
chk_cudaavailable_fail='CUDA not found'
chk_cudaavailable_check='apt list --installed 2>/dev/null | grep -E '\
'"cuda-[0-9]*-[0-9]*" | awk '"'"'{print $2}'"'"
chk_cudaavailable_eval='[ -n "$check_result" ]'
chk_cudaavailable_issue="\
  No version of CUDA detected. Our Docker only supports CUDA installations from
  the official Nvidia repository. Please add the Nvidia repository, & install 
  'cuda' through apt."
chk_cudaavailable_fix="${chk_nvidiadriver_fix//$NVIDIA_DEFAULT/$CUDA_DEFAULT}"
chk_cudaavailable_reboot=1

chk_cudaversion_name='CUDA version valid'
chk_cudaversion_pass='Valid ($check_result)'
chk_cudaversion_fail='Invalid'
chk_cudaversion_check='/usr/local/cuda/bin/nvcc --version | grep release | '\
'sed '"'"'s/.*release \([0-9\.]*\).*/\1/'"'"''
chk_cudaversion_eval='eval_version "$check_result" 10'
chk_cudaversion_issue="\
  The version of CUDA detected ("'$check_result'") is incompatible with BenchBot
  which requires at least 10.0 for the Isaac SDK.

  Please install a more recent version of CUDA from the Nvidia repository."
chk_cudaversion_fix="${chk_nvidiadriver_fix//$NVIDIA_DEFAULT/$CUDA_DEFAULT}"
chk_cudaversion_reboot=1

chk_cudappa_name='CUDA is from the Nvidia PPA'
chk_cudappa_pass='PPA is valid'
chk_cudappa_fail='PPA is invalid'
chk_cudappa_check=\
'installed=$(apt list --installed 2>/dev/null | grep -E "cuda-$(\
/usr/local/cuda/bin/nvcc --version | grep release | \
sed '"'"'s/.*release \([0-9\.]*\).*/\1/'"'"')"); \
apt download --print-uris "$(echo "$installed" | sed '"'"'s/\([^\/]*\).*/\1/'"'"')=$(echo "$installed" | cut -d " " -f 2)" 2>/dev/null'
chk_cudappa_eval=\
'[[ "$check_result" =~ .*('"'"'developer.download.nvidia.com/'"'"').* ]]'
chk_cudappa_issue="\
  CUDA was detected to have come from somewhere other than the Nvidia PPAs. The 
  CUDA package was sourced from:
    "'$check_result'"

  Our Docker container only supports official CUDA installs, & GPUs only work in 
  containers if the CUDA version exactly matches the version of the host.
  Please install CUDA from the official Nvidia repository:
    http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64"
chk_cudappa_fix=\
'sudo apt remove -y cuda-10* && sudo apt -y autoremove; '\
"${chk_nvidiadriver_fix//$NVIDIA_DEFAULT/$CUDA_DEFAULT}"
chk_cudappa_reboot=1

chk_dockeravailable_name='Docker is available'
chk_dockeravailable_pass='Found'
chk_dockeravailable_fail='Not found'
chk_dockeravailable_check='docker --version 2>/dev/null'
chk_dockeravailable_eval='[ -n "$check_result" ]'
chk_dockeravailable_issue="\
  Docker was not detected on the host system ('docker --version' did not return
  a version).

  Please ensure Docker Engine - Community Edition is installed on the system."
chk_dockeravailable_fix=\
'sudo apt install -y apt-transport-https ca-certificates curl \
  software-properties-common &&
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - &&
sudo add-apt-repository "deb [arch=amd64] \
  https://download.docker.com/linux/ubuntu '"$(lsb_release -cs)"' stable" &&
sudo apt update &&
sudo apt install -y docker-ce &&
sudo groupadd docker;
sudo usermod -aG docker '"$USER"
chk_dockeravailable_reboot=0

chk_dockerversion_name='Docker version valid'
chk_dockerversion_pass='Valid ($check_result)'
chk_dockerversion_fail='Invalid ($check_result)'
chk_dockerversion_check='docker --version 2>/dev/null | '\
'sed "s/Docker version \([^,]*\).*/\1/"'
chk_dockerversion_eval='eval_version "$check_result" 19.03'
chk_dockerversion_issue="\
  The version of Docker running ("'$check_result'") is incompatible with the 
  BenchBot built process which requires at least version 19.03 to use the
  Nvidia Container Toolkit.

  Please install a more recent version of Docker Engine - Community Edition."
chk_dockerversion_fix=\
'sudo apt remove -y docker* && sudo apt -y autoremove;
sudo apt-get install apt-transport-https ca-certificates curl \
  software-properties-common &&
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - &&
sudo add-apt-repository "deb [arch=amd64] \
  https://download.docker.com/linux/ubuntu '"$(lsb_release -cs)"' stable" &&
sudo apt update &&
sudo apt install -y docker-ce &&
sudo groupadd docker;
sudo usermod -aG docker '"$USER"
chk_dockerversion_reboot=0

chk_dockernct_name='Nvidia Container Toolkit installed'
chk_dockernct_pass='Found ($check_result)'
chk_dockernct_fail='Not found'
chk_dockernct_check='nvidia-container-cli --version 2>/dev/null | head -n 1 | '\
'cut -d " " -f2'
chk_dockernct_eval='[ -n "$check_result" ]'
chk_dockernct_issue="\
  Nvidia Container Toolkit was not detected. It is required to allow Docker
  containers to access the GPU on your host system.

  Please install the toolkit from https://github.com/NVIDIA/nvidia-docker"
chk_dockernct_fix=\
'curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add - &&
curl -s -L "https://nvidia.github.io/nvidia-docker/\
'"$(. /etc/os-release;echo $ID$VERSION_ID)"'/nvidia-docker.list" | \
  sudo tee /etc/apt/sources.list.d/nvidia-docker.list &&
sudo apt update && 
sudo apt install -y nvidia-container-toolkit &&
sudo systemctl restart docker'
chk_dockernct_reboot=1

chk_dockerroot_name='Docker runs without root'
chk_dockerroot_pass='Passed'
chk_dockerroot_fail='Failed'
chk_dockerroot_check='docker run --rm hello-world &>/dev/null; echo $?'
chk_dockerroot_eval='[ $check_result -eq 0 ]'
chk_dockerroot_issue="\
  Docker failed to run the hello-world test.

  Usually this is caused by Docker not being configured to run without root. If
  the fix below fails to fix the issue (a restart / logout is required after
  changing groups), please run 'docker run hello-world' & resolve any issues
  that occur."
chk_dockerroot_fix=\
'sudo groupadd docker;
sudo usermod -aG docker '"$USER"
chk_dockerroot_reboot=0

chk_fsext4_name='/var/lib/docker on ext4 filesystem'
chk_fsext4_pass='Yes ($check_result)'
chk_fsext4_fail='No'
chk_fsext4_check=\
'if [ $(df -T /var/lib/docker | awk '"'"'/^\// {print $2}'"'"') == "ext4" ]; \
   then df -T /var/lib/docker | awk '"'"'/^\// {print $1}'"'"'; fi'
chk_fsext4_eval='[ -n "$check_result" ]'
chk_fsext4_issue="\
  The location of Docker images, '/var/lib/docker', is on partition '"'$check_result'"'
  which is not a fileystem of type 'ext4'. Non-ext4 filesystems have generally
  been found to produce unstable behaviour with Linux Docker images.

  Please move '/var/lib/docker/' to an ext4 drive for best results."
chk_fsext4_fix=\
'clear_stdin
read -p "New location for /var/lib/docker on an ext4 drive: " new_location
sudo systemctl stop docker
sudo mv /var/lib/docker "$new_location"
sudo ln -sv "$new_location" /var/lib/docker
sudo systemctl start docker'
chk_fsext4_reboot=1

chk_fsnosuid_name='/var/lib/docker supports suid'
chk_fsnosuid_pass='Enabled'
chk_fsnosuid_fail='Disabled'
chk_fsnosuid_check=\
'if [ -z $(cat /proc/mounts | grep $(df -T /var/lib/docker | \
awk '"'"'/^\// {print $1}'"'"') | grep "nosuid") ]; then \
   df -T /var/lib/docker | awk '"'"'/^\// {print $1}'"'"'; fi'
chk_fsnosuid_eval='[ -n "$check_result" ]'
chk_fsnosuid_issue="\
  Support for suid flags was not found on the drive holding /var/lib/docker:
  "'$check_result'"
  
  Please disable the nosuid option on the drive (by editing /etc/fstab, using
  the Ubuntu Disk UI, or any other method you prefer). "
chk_fsnosuid_fix=\
'sudo sed -E -n '"'"'s|(^[^#]*'"'"'$check_result'"'"' .*)nosuid|\1|p; s/,,/,/p; \
   s/ ,/ /p; s/, / /p'"'"' /etc/fstab &&
sudo systemctl daemon-reload'
chk_fsnosuid_reboot=1

chk_fsspace_name='/var/lib/docker drive space check'
chk_fsspace_pass='Sufficient space ($check_resultG)'
chk_fsspace_fail='Insufficient space ($check_resultG)'
chk_fsspace_check=\
'dup_space=$(docker images --filter "reference='$DOCKER_TAG_BACKEND'" \
  --format "{{.Size}}") &&
if [ -z "$dup_space" ]; 
  then dup_space=0; 
elif [ "${dup_space: -2}" == "GB" ]; 
  then dup_space=$(echo "${dup_space:0:-2}" | sed '"'"'s/\..*$//'"'"');
else 
  dup_space=0;
fi &&
space=$(df -Th -BG /var/lib/docker | awk '"'"'/^\// {print $5}'"'"') &&
space=$(echo "${space:0:-1}" | sed '"'"'s/\..*$//'"'"') &&
echo "$space+$dup_space" | bc'
chk_fsspace_eval='[ $check_result -gt SIZE ]'
chk_fsspace_issue="\
  The drive holding /var/lib/docker needs at least SIZEGB free. This check takes
  into account if you already have BenchBot installed (it will add the size of
  the Docker image to your \"available space\").

  Please clear space from the drive, or run the following fix to move
  /var/lib/docker to a drive with more space."
chk_fsspace_fix=\
'clear_stdin
read -p "New location for /var/lib/docker with SIZEGB free: " new_location
sudo systemctl stop docker
sudo mv /var/lib/docker "$new_location"
sudo ln -sv "$new_location" /var/lib/docker
sudo systemctl start docker'
chk_fsspace_reboot=1

chk_pip_name='Pip python package manager available'
chk_pip_pass='Found ($check_result)'
chk_pip_fail='Not found'
chk_pip_check=\
'python3 -m pip --version 2>/dev/null | cut -d " " -f 2'
chk_pip_eval='[ -n "$check_result" ]'
chk_pip_issue="\
  Python package manager pip was not found. It is required for installation of
  BenchBot python modules. Please either restart the install script with pip
  available, or install it."
chk_pip_fix='sudo apt install -y python3-pip && pip3 install --upgrade pip'
chk_pip_reboot=1

chk_pythontk_name='Tkinter for Python installed'
chk_pythontk_pass='Found'
chk_pythontk_fail='Not found'
chk_pythontk_check='python3 -c "import tkinter as tk; print(tk.__file__)" 2>/dev/null'
chk_pythontk_eval='[ -n "$check_result" ]'
chk_pythontk_issue="\
  Python package pythontk was not found. It is required to use the
  visualisation tools available with the BenchBot API. Please install it via
  package manager. "
chk_pythontk_fix='sudo apt install -y python3-tk'
chk_pythontk_reboot=1


checks_list_sim_omni=(
  "Manual installation steps for Omniverse-powered Isaac Sim:"
  "simomnilicense"
  "simomninvcrio"
  )

chk_simomnilicense_name='License accepted for Omniverse'
chk_simomnilicense_pass='Yes'
chk_simomnilicense_fail='No'
chk_simomnilicense_check='echo "'$PATH_LICENSES'/omniverse"'
chk_simomnilicense_eval='[ -f "$check_result" ]'
chk_simomnilicense_issue="\
  The NVIDIA Omniverse License Agreement (EULA) must be accepted before
  Omniverse Kit can start. The license terms for this product can be viewed at:
    https://docs.omniverse.nvidia.com/app_isaacsim/common/NVIDIA_Omniverse_License_Agreement.html

  Accept the following command to accept the license."
chk_simomnilicense_fix=\
'mkdir -p '$PATH_LICENSES' && touch "'$PATH_LICENSES'/omniverse"'
chk_simomnilicense_reboot=1

chk_simomninvcrio_name='Access to nvcr.io Docker registry'
chk_simomninvcrio_pass='Yes'
chk_simomninvcrio_fail='No'
chk_simomninvcrio_check='echo "" | docker login nvcr.io &>/dev/null; echo $?'
chk_simomninvcrio_eval='[ $check_result -eq 0 ]'
chk_simomninvcrio_issue="\
  Could not access the nvcr.io Docker registry.

  Please follow the NVIDIA's instruction for generating an account NGC key:
    https://docs.nvidia.com/ngc/ngc-overview/index.html#generating-api-key

  Then either:
    1) Follow the Isaac Sim instructions to login (DON'T USE sudo):
      https://docs.omniverse.nvidia.com/app_isaacsim/app_isaacsim/install_advanced.html
    2) Run the auto-fix below, and paste your key in when prompted."
chk_simomninvcrio_fix=\
'clear_stdin
read -p "NGC API Key for your account: " ngc_key
echo "$ngc_key" | docker login --username \$oauthtoken --password-stdin nvcr.io'
chk_simomninvcrio_reboot=1


checks_list_post=(
  "Validating the build against the host system:"
  "cudadriverdep"  # Does Nvidia driver satisfy cuda dep?
  "Validating BenchBot libraries on the host system:"
  "addonscloned"
  "addonsuptodate"
  "addonsinstalled"
  "apicloned"
  "apiuptodate"
  "apiinstalled"
  "evalcloned"
  "evaluptodate"
  "evalinstalled"
  "Integrating BenchBot with the host system:"
  "hostsavail"
  "symlinks"
  )

chk_cudadriverdep_name='CUDA / Nvidia versions match'
chk_cudadriverdep_pass='Matches'
chk_cudadriverdep_fail='Does not match'
chk_cudadriverdep_check=\
'fn='"'"'echo "Nvidia: $(cat /proc/driver/nvidia/version | \
  sed "/NVRM version/!d; s/.*Kernel Module *\([0-9\.]*\).*/\1/"), \
  CUDA: $(apt list --installed 2>/dev/null | grep -E "cuda-$(\
  /usr/local/cuda/bin/nvcc --version | grep release | \
  sed "s/.*release \([0-9\.]*\).*/\1/")" | cut -d " " -f 2)"'"'"' && 
host=$(eval "$fn") && 
bb=$(docker run --rm -t '$DOCKER_TAG_CORE' /bin/bash -c "$fn" | \
  sed '"'"'s/[[:space:]]*$//'"'"') &&
eq=$([ "$host" == "$bb" ] && echo "==" || echo "!=") &&
printf "%s\n%s\n%s" "Host: $host" "BenchBot: $bb" "Result: $eq"'
chk_cudadriverdep_eval='[[ "$check_result" == *"=="* ]]'
chk_cudadriverdep_issue="\
  The CUDA / Nvidia driver version pairing in the installed BenchBot does not
  match the version on your host system, despite our best efforts:

"'$check_result'"

  This can sometimes happen due to the way CUDA / Nvidia driver pairings are
  passed through the apt dependency tree (cuda -> cuda-drivers ->
  nvidia-driver)

  BenchBot needs these to match between host & docker, so the best solution 
  available at this point is remove the existing CUDA install on the host 
  machine & reinstall. Please do this if we have identified this issue with your 
  host system setup."
chk_cudadriverdep_fix=\
'v=$(apt list --installed 2>/dev/null | grep "cuda-[0-9]*-[0-9]*") &&
if [ -z "$v" ]; then v="cuda-10-1"; fi &&
sudo apt remove -y "$v" && sudo apt -y autoremove && sudo apt install -y "$v"'
chk_cudadriverdep_reboot=1

chk_addonscloned_name='BenchBot Add-ons Manager cloned'
chk_addonscloned_pass='Yes'
chk_addonscloned_fail='No'
chk_addonscloned_check=\
'git -C '"$PATH_ADDONS"' rev-parse --show-toplevel 2>/dev/null'
chk_addonscloned_eval='[ "$check_result" == "$(realpath '"$PATH_ADDONS"')" ]'
chk_addonscloned_issue="\
  The BenchBot Add-ons Manager Python library is not cloned on the host system.
  Having it installed is required for using add-ons, which contain all of the
  pre-made content for BenchBot (robots, environments, task definitions,
  evaluation methods, etc.)."
chk_addonscloned_fix=\
'rm -rf '"$PATH_ADDONS"' && 
git clone '"$GIT_ADDONS $PATH_ADDONS"' &&
pushd '"$PATH_ADDONS"' && 
git fetch --all && (git checkout -t origin/$BRANCH_DEFAULT || 
git checkout $BRANCH_DEFAULT) && popd'
chk_addonscloned_reboot=1

chk_addonsuptodate_name='BenchBot Add-ons Manager up-to-date'
chk_addonsuptodate_pass='Up-to-date'
chk_addonsuptodate_fail='Outdated'
chk_addonsuptodate_check=\
'[ -d '"$PATH_ADDONS"' ] && git -C '"$PATH_ADDONS"' rev-parse HEAD && 
git ls-remote '"$GIT_ADDONS"' $BRANCH_DEFAULT | awk '"'"'{print $1}'"'"
chk_addonsuptodate_eval='[ -n "$check_result" ] && 
  [ $(echo "$check_result" | uniq | wc -l) -eq 1 ]'
chk_addonsuptodate_issue="\
  The version of the BenchBot Add-ons Manager Python library on the host system
  is out of date. The current version hash & latest version hash respectively
  are:

"'$check_result'"

  Please move to the latest version."
chk_addonsuptodate_fix=\
'pushd '"$PATH_ADDONS"' && 
git fetch --all && git checkout -- . &&
(git checkout -t origin/$BRANCH_DEFAULT || git checkout $BRANCH_DEFAULT) && 
git pull && popd && pip3 uninstall -y benchbot_addons'
chk_addonsuptodate_reboot=1

chk_addonsinstalled_name='BenchBot Add-ons Manager installed'
chk_addonsinstalled_pass='Available'
chk_addonsinstalled_fail='Not found'
chk_addonsinstalled_check=\
'python3 -c '"'"'import benchbot_addons; print(benchbot_addons.__file__);'"'"' \
  2>/dev/null'
chk_addonsinstalled_eval='[ -n "$check_result" ]'
chk_addonsinstalled_issue="\
  BenchBot Add-ons Manager was not found in Python. It is either not installed,
  or the current terminal is not correctly sourcing your installed Python
  packages (could be a virtual environment, conda, ROS, etc).

  Please do not run the automatic fix if you intend to source a different Python
  environment before running BenchBot."
chk_addonsinstalled_fix=\
'pushd '"$PATH_ADDONS"' &&  
python3 -m pip install --upgrade -e . && popd'
chk_addonsinstalled_reboot=1

chk_apicloned_name='BenchBot API cloned'
chk_apicloned_pass='Yes'
chk_apicloned_fail='No'
chk_apicloned_check=\
'git -C '"$PATH_API"' rev-parse --show-toplevel 2>/dev/null'
chk_apicloned_eval='[ "$check_result" == "$(realpath '"$PATH_API"')" ]'
chk_apicloned_issue="\
  The BenchBot API Python library is not cloned on the host system. Having it
  installed significantly improves the development experience, & allows you to
  run your submissions natively without containerisation."
chk_apicloned_fix=\
'rm -rf '"$PATH_API"' && 
git clone '"$GIT_API $PATH_API"' &&
pushd '"$PATH_API"' && 
git fetch --all && (git checkout -t origin/$BRANCH_DEFAULT || 
git checkout $BRANCH_DEFAULT) && popd'
chk_apicloned_reboot=1

chk_apiuptodate_name='BenchBot API up-to-date'
chk_apiuptodate_pass='Up-to-date'
chk_apiuptodate_fail='Outdated'
chk_apiuptodate_check=\
'[ -d '"$PATH_API"' ] && git -C '"$PATH_API"' rev-parse HEAD && 
git ls-remote '"$GIT_API"' $BRANCH_DEFAULT | awk '"'"'{print $1}'"'"
chk_apiuptodate_eval='[ -n "$check_result" ] && 
  [ $(echo "$check_result" | uniq | wc -l) -eq 1 ]'
chk_apiuptodate_issue="\
  The version of the BenchBot API Python library on the host system is out of
  date. The current version hash & latest version hash respectively are:

"'$check_result'"

  Please move to the latest version."
chk_apiuptodate_fix=\
'pushd '"$PATH_API"' && 
git fetch --all && git checkout -- . &&
(git checkout -t origin/$BRANCH_DEFAULT || git checkout $BRANCH_DEFAULT) && 
git pull && popd && pip3 uninstall -y benchbot_api'
chk_apiuptodate_reboot=1

chk_apiinstalled_name='BenchBot API installed'
chk_apiinstalled_pass='Available'
chk_apiinstalled_fail='Not found'
chk_apiinstalled_check=\
'python3 -c '"'"'import benchbot_api; print(benchbot_api.__file__);'"'"' \
  2>/dev/null'
chk_apiinstalled_eval='[ -n "$check_result" ]'
chk_apiinstalled_issue="\
  BenchBot API was not found in Python. It is either not installed, or the 
  current terminal is not correctly sourcing your installed Python packages 
  (could be a virtual environment, conda, ROS, etc).

  Please do not run the automatic fix if you intend to source a different Python
  environment before running BenchBot."
chk_apiinstalled_fix=\
'pushd '"$PATH_API"' &&  
python3 -m pip install --upgrade -e . && popd'
chk_apiinstalled_reboot=1

chk_evalcloned_name='BenchBot evaluation cloned'
chk_evalcloned_pass='Yes'
chk_evalcloned_fail='No'
chk_evalcloned_check=\
'git -C '"$PATH_EVAL"' rev-parse --show-toplevel 2>/dev/null'
chk_evalcloned_eval='[ "$check_result" == "$(realpath '"$PATH_EVAL"')" ]'
chk_evalcloned_issue="\
  The BenchBot evaluation Python library is not cloned on the host system.
  Having it installed allows you to evaluate the performance of your semantic
  scene understanding algorithms directly from your machine."
chk_evalcloned_fix=\
'rm -rf '"$PATH_EVAL"' && 
git clone '"$GIT_EVAL $PATH_EVAL"' &&
pushd '"$PATH_EVAL"' && 
git fetch --all && (git checkout -t origin/$BRANCH_DEFAULT || 
git checkout $BRANCH_DEFAULT) && popd'
chk_evalcloned_reboot=1

chk_evaluptodate_name='BenchBot evaluation up-to-date'
chk_evaluptodate_pass='Up-to-date'
chk_evaluptodate_fail='Outdated'
chk_evaluptodate_check=\
'[ -d '"$PATH_EVAL"' ] && git -C '"$PATH_EVAL"' rev-parse HEAD && 
git ls-remote '"$GIT_EVAL"' $BRANCH_DEFAULT | awk '"'"'{print $1}'"'"
chk_evaluptodate_eval='[ -n "$check_result" ] &&
  [ $(echo "$check_result" | uniq | wc -l) -eq 1 ]'
chk_evaluptodate_issue="\
  The version of the BenchBot evaluation Python library on the host system is
  out of date. The current version hash & latest version hash respectively are:

"'$check_result'"

  Please move to the latest version."
chk_evaluptodate_fix=\
'pushd '"$PATH_EVAL"' && 
git fetch --all && git checkout -- . &&
(git checkout -t origin/$BRANCH_DEFAULT || git checkout $BRANCH_DEFAULT) && 
git pull && popd && python3 -m pip uninstall -y benchbot_eval'
chk_evaluptodate_reboot=1

chk_evalinstalled_name='BenchBot evaluation installed'
chk_evalinstalled_pass='Available'
chk_evalinstalled_fail='Not found'
chk_evalinstalled_check=\
'python3 -c '"'"'import benchbot_eval; print(benchbot_eval.__file__);'"'"' \
  2>/dev/null'
chk_evalinstalled_eval='[ -n "$check_result" ]'
chk_evalinstalled_issue="\
  BenchBot evaluation was not found in Python. It is either not installed, or
  the current terminal is not correctly sourcing your installed Python packages
  (could be a virtual environment, conda, ROS, etc).

  Please do not run the automatic fix if you intend to source a different Python
  environment before running BenchBot."
chk_evalinstalled_fix=\
'pushd '"$PATH_EVAL"' && 
python3 -m pip install --upgrade -e . && popd'
chk_evalinstalled_reboot=1

chk_hostsavail_name='BenchBot hosts available'
chk_hostsavail_pass='Found'
chk_hostsavail_fail='Not found'
chk_hostsavail_check=\
'getent hosts benchbot_ros benchbot_robot benchbot_supervisor benchbot_debug'
chk_hostsavail_eval='[ $(echo "$check_result" | wc -l) -eq 4 ]'
chk_hostsavail_issue="\
  The hosts benchbot_ros, benchbot_simulator, & benchbot_supervisor were not
  found on the host system. Only the following hosts were found (may be empty):

"'$check_result'"

  Having all hosts available to your system allows the BenchBot software stack
  to communicate between each of the individual components. Please add the host
  to your /etc/hosts file."
chk_hostsavail_fix=\
'echo -e "\n$hostnames_block" | sudo tee -a /etc/hosts'
chk_hostsavail_reboot=1

chk_symlinks_name='BenchBot symlinks available'
chk_symlinks_pass='Found'
chk_symlinks_fail='Not found'
chk_symlinks_check=\
'[ -e "'$PATH_SYMLINKS'/benchbot_install" ] && 
  [ -e "'$PATH_SYMLINKS'/benchbot_run" ] &&
  [ -e "'$PATH_SYMLINKS'/benchbot_submit" ] &&
  [ -e "'$PATH_SYMLINKS'/benchbot_eval" ] &&
  [ -e "'$PATH_SYMLINKS'/benchbot_batch" ] &&
  ls -l "'$PATH_SYMLINKS'/benchbot_"* | cut -d " " -f 9-11'
chk_symlinks_eval='[ -n "$check_result" ]'
chk_symlinks_issue="\
  Symbolic links for each of the 5 BenchBot scripts were not found. If you do 
  not wish to add symbolic links, or would rather add the './bin/' directory to
  your PATH, please skip this step."
chk_symlinks_fix=\
'sudo ln -svf '"$(dirname $abs_path)"'/* '"$PATH_SYMLINKS"
chk_symlinks_reboot=1

################################################################################
######################## Helper functions for commands #########################
################################################################################

function cleanup_terminal() {
  printf "${colour_nc}"
}

function handle_requirement() {
  required=${2:-0}

  # Dirtily pull all of the check-related values based from the input argument
  name=$(eval 'echo "$chk_'$1'_name"')
  pass=$(eval 'echo "$chk_'$1'_pass"')
  fail=$(eval 'echo "$chk_'$1'_fail"')
  check=$(eval 'echo "$chk_'$1'_check"')
  evaluate=$(eval 'echo "$chk_'$1'_eval"')
  issue=$(eval 'echo "$chk_'$1'_issue"')
  fix=$(eval 'echo "$chk_'$1'_fix"')
  reboot=$(eval 'echo "$chk_'$1'_reboot"')

  # Perform the check, printing the result & resolving issues if possible
  retval=0
  printf "\t$name: "
  check_result=$(eval "$check") && true
  printf "\033[46G"
  if $(eval $evaluate); then 
    printf "${colour_green}%35s" "${pass//'$check_result'/$check_result}"
    retval=0
  else 
    printf "${colour_yellow}%35s\n${colour_nc}" \
      "${fail//'$check_result'/$check_result}"
    printf "\n${colour_yellow}%s\n" "${issue//'$check_result'/$check_result}"
    if [ -z "$fix" ]; then
      printf "\n  No automatic fix is available.\n"
      unresolved=1
    else
      printf "\n  The following commands can be run to try & fix the issue:\n"
      printf "\n%s\n\n" "${fix//'$check_result'/$check_result}"
      clear_stdin
      read -n 1 -r -p "  Would you like the above commands to be run (y/N)? " \
        apply_fix
      if [[ "$apply_fix" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        printf "\n\n${colour_nc}"
        eval "$fix"
        unresolved=$?
        printf "\n${colour_yellow}"
        if [ "$reboot" -eq 0 ] && [ $unresolved -eq 0 ]; then
          s="Please reboot your machine before re-running the install script." 
          printf "\n  $s"
          retval=1
        elif [ $unresolved -eq 0 ] && [ $required -eq 0 ]; then
          printf "\n  Restarting the installation script ...\n"
          retval=2
        fi
      else
        unresolved=1
      fi
    fi
    if [ $unresolved -ne 0 ] && [ $required -eq 0 ]; then
      s="Failed to solve issue. Please manually resolve, & re-run the "
      s+="install script."
      printf "\n  $s"
      retval=1
    elif [ $required -ne 0 ]; then
      printf "\n"
    fi
  fi
  printf "${colour_nc}\n"
  return $retval
}

function uninstall_benchbot() {
  kill_benchbot

  header_block "UNINSTALLING BENCHBOT" ${colour_blue}

  pkgs="$(python3 -m pip freeze | grep benchbot || true)"
  if [ -n "$pkgs" ]; then
    echo "$pkgs" | sed 's/.*egg=\(.*\)/\1/' | xargs python3 -m pip uninstall -y
  fi
  sitepkgs=($(echo "$(python3 -c 'import site; \
    print(" ".join(site.getsitepackages() + [site.getusersitepackages()]))' \
    2>/dev/null)" | tr ' ' '\n'))
  if [ -n "$sitepkgs" ] ; then 
    echo "Manually removing eggs from pip ..."
    # This fix is needed as apparently Ubuntu patches broke pip uninstall...
    # See: https://github.com/pypa/pip/issues/4438
    for l in "${sitepkgs[@]}"; do
      # The loop below is WAY TOO AGGRESSIVE... but I can't do anything else
      # due to the bug above, & inconsistency of where this file will be saved
      # between raw python install, virtualenvs, conda, etc etc
      find "$l" -regex '.*benchbot-\(api\|eval\).*' -print -delete \
        2>/dev/null || true
    done
  fi

  targets=$(docker images -q -f reference='benchbot/*:*')
  if [ -n "$targets" ] ; then 
    echo "Removing BenchBot Docker resources ..."
    docker rmi -f $targets; 
  fi

  rm -rfv "$PATH_ADDONS" "$PATH_API" "$PATH_EVAL" \
    2>/dev/null || true
  sudo rm -v "$PATH_SYMLINKS"/benchbot* 2>/dev/null || true

  echo -e "\nFinished uninstalling!"
}

################################################################################
################## Parse & handle arguments / installer state ##################
################################################################################

# Cleanup terminal colours whenever exiting
trap cleanup_terminal EXIT

# Safely parse options input
input=("$@")
_args="help,addons:,addons-only:,branch:,force-clean,uninstall,list-addons,\
list-simulators,no-simulator,no-update,remove-addons:,simulators:,version"
parse_out=$(getopt -o ha:A:b:fs:uv --long $_args -n "$(basename "$abs_path")" \
  -- "$@")
if [ $? != 0 ]; then exit 1; fi
eval set -- "$parse_out"
addons=
no_simulator=
simulators="$SIMULATOR_DEFAULT"
updates_skip=
while true; do
  case "$1" in
    -h|--help)
      echo "$usage_text" ; exit 0 ;;
    -a|--addons)
      addons="$2"; shift 2 ;;
    -A|--addons-only)
      install_addons "$2"; exit 0 ;;
    -b|--branch)
      # This is a real dirty way to do this... sorry
      BRANCH_DEFAULT="$2"; shift 2
      printf "\n${colour_yellow}%s${colour_nc}\n\n" \
        "Using branch '$BRANCH_DEFAULT' instead of the default!" ;;
    -f|--force-clean)
      uninstall_benchbot; shift ;;
    -s|--simulators)
      simulators="$2"; shift 2 ;;
    -u|--uninstall)
      uninstall_benchbot; exit ;;
    -v|--version)
      print_version_info; exit ;;
    --list-addons)
      list_addons; exit ;;
    --list-simulators)
      list_simulators; exit ;; 
    --no-simulator)
      no_simulator=1; shift ;;
    --no-update)
      updates_skip=1; shift ;;
    --remove-addons)
      remove_addons "$2"; exit ;;
    --)
      shift ; break ;;
    *)
      echo "$(basename "$abs_path"): option '$1' is unknown"; shift ; exit 1 ;;
  esac
done

# Validate and sanitise argument values
validate_install_args "$simulators"
if [ -z "$addons" ]; then addons="$ADDONS_DEFAULT"; fi
simulators=( $([ -z "$no_simulator" ] && echo "$simulators" | sed 's/,/\n/g') )

# Pre-install
if [ -z "$updates_skip" ]; then
  header_block "CHECKING BENCHBOT SCRIPTS VERSION" ${colour_blue}

  echo -e "\nFetching latest hash for Benchbot scripts ... "
  _benchbot_info=$(is_latest_benchbot $BRANCH_DEFAULT) && is_latest=0 || \
    is_latest=1
  benchbot_latest_hash=$(echo "$_benchbot_info" | latest_version_info | \
    cut -d ' ' -f 1)
  echo -e "\t\t$benchbot_latest_hash."

  if [ $is_latest -eq 0 ]; then 
    echo -e "\n${colour_green}BenchBot scripts are up-to-date.${colour_nc}"
  elif [ $is_latest -eq 1 ]; then
    echo -e "\n${colour_yellow}BenchBot scripts are outdated. Updating &"\
      "restarting install script ...\n${colour_nc}"
    git fetch --all && git checkout -- . && git checkout "$benchbot_latest_hash"
    echo -e "\n${colour_yellow}Done.${colour_nc}"
    popd > /dev/null && exec $0 ${input[@]} --no-update
  else
    echo -e "$_benchbot_info"
    exit 1
  fi
fi

################################################################################
############################# Installation process #############################
################################################################################


# PART 1: Ensuring the system state is compatible with BenchBot
header_block "PART 1: EXAMINING SYSTEM STATE" $colour_blue

# Patch in any values that can only be determined at runtime
# TODO clean this up to properly understand sizes for different simulators...
_sz=$([ -n "$simulators" ] && echo "$SIZE_GB_FULL" || echo "$SIZE_GB_LITE")
chk_fsspace_eval=${chk_fsspace_eval/SIZE/$_sz}
chk_fsspace_issue=${chk_fsspace_issue/SIZE/$_sz}
chk_fsspace_fix=${chk_fsspace_fix/SIZE/$_sz}

# Create our list of checks based on what simulators where requested
_chks=("${checks_list_pre[@]}")
for s in "${simulators[@]}"; do
  _chks=("${_chks[@]}" $(printf "%s\n" "${checks_list_sim_omni[@]}") )
done

# Iterate through the list of checks, doing some dirty string based variable
# extraction in the handle_requirement() function...
for c in "${_chks[@]}"; do
  if [[ "$c" =~ :$ ]]; then
    printf "\n${colour_blue}$c${colour_nc}\n"
  elif [ -n "$c" ]; then
    set +e
    handle_requirement "$c"
    res=$?
    set -e
    if [ $res -eq 2 ]; then
      popd > /dev/null && exec $0 ${input[@]}
    elif [ $res -eq 1 ]; then
      exit 1
    fi
  fi
done

printf "\n\n"
clear_stdin
s="All requirements & dependencies fulfilled. Docker containers for the BenchBot\n"
s+="software stack will now be built (which may take anywhere from a few seconds\n"
s+="to many hours). Would you like to proceed (y/N)? "
read -n 1 -r -e -p "$(printf "${colour_green}$s${colour_nc}")" prompt
printf "\n"
if [[ "$prompt" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
  printf "Proceeding with install ... \n\n"
else
  printf "Install aborted.\n\n"
  exit 1
fi

# PART 2: Fetching information about latest benchbot versions
header_block "PART 2: FETCHING LATEST BENCHBOT VERSION INFO" $colour_blue

# Get the latest commit hashes for each of our git repos
# TODO adapt this to handle multiple simulators...
hash_fail_msg="Failed (check Internet connection & valid branch name!). Exiting."
if [ -n "$simulators" ]; then
  benchbot_simulator_hashes=()
  for s in "${simulators[@]}"; do
    echo -e "\nFetching latest hash for BenchBot Simulator '$s' ... "
    benchbot_simulator_hashes+=$( \
      (is_latest_benchbot_simulator $s $BRANCH_DEFAULT || true) | \
      latest_version_info \
    )
    if [ -z "${benchbot_simulator_hashes[-1]}" ]; then
      printf "\n${colour_red}$hash_fail_msg${colour_nc}\n\n" 
      exit 1
    fi
    echo -e "\t\t${benchbot_simulator_hashes[-1]}."
  done
fi
echo "Fetching latest hash for BenchBot Robot Controller ... "
benchbot_controller_hash=$( (is_latest_benchbot_controller $BRANCH_DEFAULT || \
  true) | latest_version_info)
if [ -z "$benchbot_controller_hash" ]; then
  printf "\n${colour_red}$hash_fail_msg${colour_nc}\n\n"
  exit 1
fi
echo -e "\t\t$benchbot_controller_hash."
echo "Fetching latest hash for BenchBot Supervisor ... "
benchbot_supervisor_hash=$( (is_latest_benchbot_supervisor $BRANCH_DEFAULT || \
  true) | latest_version_info)
if [ -z "$benchbot_supervisor_hash" ]; then
  printf "\n${colour_red}$hash_fail_msg${colour_nc}\n\n"
  exit 1
fi
echo -e "\t\t$benchbot_supervisor_hash."
echo "Fetching latest hash for BenchBot API ... "
benchbot_api_hash=$( (is_latest_benchbot_api $BRANCH_DEFAULT || true) | \
  latest_version_info)
if [ -z "$benchbot_api_hash" ]; then
  printf "\n${colour_red}$hash_fail_msg${colour_nc}\n\n"
  exit 1
fi
echo -e "\t\t$benchbot_api_hash."

echo "Fetching latest hash for BenchBot ROS Messages ... "
benchbot_msgs_hash=$( (is_latest_benchbot_msgs $BRANCH_DEFAULT || true) | \
  latest_version_info)
if [ -z "$benchbot_msgs_hash" ]; then
  printf "\n${colour_red}$hash_fail_msg${colour_nc}\n\n"
  exit 1
fi
echo -e "\t\t$benchbot_msgs_hash."

# PART 3: Build docker images (both simulator & submission base image)
header_block "PART 3: BUILDING DOCKER IMAGES" $colour_blue

# Gather some useful variables, including from the host
_tmp_dockerfile="/tmp/dockerfile"
nvidia_driver_version=$(apt list --installed 2>/dev/null | \
  grep "nvidia-driver-" | cut -d ' ' -f 2)
cuda_drivers_version=$(apt list --installed 2>/dev/null | \
  grep "cuda-drivers/" | cut -d ' ' -f 2)
cuda_version=$(apt list --installed 2>/dev/null | \
  grep "cuda-$(/usr/local/cuda/bin/nvcc --version | grep release | \
  sed 's/.*release \([0-9\.]*\).*/\1/; s/\./-/g')" | cut -d ' ' -f 2)

# Build the BenchBot Core Docker image
printf "\n${colour_blue}%s${colour_nc}\n" \
  "BUILDING BENCHBOT CORE DOCKER IMAGE:"
docker buildx build -t "$DOCKER_TAG_CORE" -f "$PATH_DOCKERFILE_CORE" \
  --build-arg TZ=$(cat /etc/timezone) \
  --build-arg NVIDIA_DRIVER_VERSION="${nvidia_driver_version}" \
  --build-arg CUDA_DRIVERS_VERSION="${cuda_drivers_version}" \
  --build-arg CUDA_VERSION="${cuda_version}" $PATH_ROOT && \
  build_ret=0 || build_ret=1
if [ $build_ret -ne 0 ]; then
  printf "\n${colour_red}%s: %d\n\n${build_err}${colour_nc}\n" \
    "ERROR: Building BenchBot \"core\" returned a non-zero error code" \
    "$build_ret"
  exit 1
fi

# Build the BenchBot Backend Docker image
printf "\n${colour_blue}%s${colour_nc}\n" \
  "BUILDING BENCHBOT BACKEND DOCKER IMAGE:"
cat "$PATH_DOCKERFILE_BACKEND" "$PATH_DOCKERFILE_SHARED" > "$_tmp_dockerfile"
docker buildx build -t "$DOCKER_TAG_BACKEND" -f - \
  --build-arg BENCHBOT_CONTROLLER_GIT="${GIT_CONTROLLER}" \
  --build-arg BENCHBOT_CONTROLLER_HASH="${benchbot_controller_hash}" \
  --build-arg BENCHBOT_MSGS_GIT="${GIT_MSGS}" \
  --build-arg BENCHBOT_MSGS_HASH="${benchbot_msgs_hash}" \
  --build-arg BENCHBOT_SUPERVISOR_GIT="${GIT_SUPERVISOR}" \
  --build-arg BENCHBOT_SUPERVISOR_HASH="${benchbot_supervisor_hash}" \
  --build-arg BENCHBOT_ADDONS_PATH="${PATH_ADDONS_INTERNAL}" \
  $PATH_ROOT < "$_tmp_dockerfile" && build_ret=0 || build_ret=1
if [ $build_ret -ne 0 ]; then
  printf "\n${colour_red}%s: %d\n\n${build_err}${colour_nc}\n" \
    "ERROR: Building BenchBot backend returned a non-zero error code" \
    "$build_ret"
  exit 1
fi

# Build Docker images for each of the requested simulators
for i in "${!simulators[@]}"; do
  s="${simulators[i]}"
  printf "\n${colour_blue}%s${colour_nc}\n" \
    "BUILDING BENCHBOT SIMULATOR '$s' DOCKER IMAGE:"
  cat "$PATH_DOCKERFILE_SIM_PREFIX$s.Dockerfile" "$PATH_DOCKERFILE_SHARED" > \
    "$_tmp_dockerfile"
  docker buildx build -t "$DOCKER_TAG_SIM_PREFIX$s" -f - \
    --build-arg BENCHBOT_CONTROLLER_GIT="${GIT_CONTROLLER}" \
    --build-arg BENCHBOT_CONTROLLER_HASH="${benchbot_controller_hash}" \
    --build-arg BENCHBOT_MSGS_GIT="${GIT_MSGS}" \
    --build-arg BENCHBOT_MSGS_HASH="${benchbot_msgs_hash}" \
    --build-arg BENCHBOT_SIMULATOR_GIT="${GIT_SIMULATOR_PREFIX}${s}" \
    --build-arg BENCHBOT_SIMULATOR_HASH="${benchbot_simulator_hashes[i]}" \
    --build-arg BENCHBOT_ADDONS_PATH="${PATH_ADDONS_INTERNAL}" \
    $PATH_ROOT < "$_tmp_dockerfile" && build_ret=0 || build_ret=1
  if [ $build_ret -ne 0 ]; then
    printf "\n${colour_red}%s: %d\n\n${build_err}${colour_nc}\n" \
      "ERROR: Building BenchBot simulator '$s' returned a non-zero error code" \
      "$build_ret"
    exit 1
  fi
done

# Build the BenchBot Submission Docker image
printf "\n${colour_blue}%s${colour_nc}\n" \
  "BUILDING BENCHBOT SUBMISSION DOCKER IMAGE:"
docker buildx build -t "$DOCKER_TAG_SUBMISSION" \
  -f "$PATH_DOCKERFILE_SUBMISSION" \
  --build-arg BENCHBOT_API_GIT="${GIT_API}" \
  --build-arg BENCHBOT_API_HASH="${benchbot_api_hash}" $PATH_ROOT && \
  build_ret=0 || build_ret=1
if [ $build_ret -ne 0 ]; then
  printf "\n${colour_red}%s: %d\n\n${build_err}${colour_nc}\n" \
    "ERROR: Building BenchBot \"submission\" returned a non-zero error code" \
    "$build_ret"
  exit 1
fi

rm "$_tmp_dockerfile"

# Cleanup any unnecessary / outdated BenchBot components still lying around
printf "\n${colour_blue}%s${colour_nc}\n" \
  "CLEANING UP OUTDATED BENCHBOT REMNANTS:"
kill_benchbot "quiet"

# PART 4: Running post build checks
header_block "PART 4: RUNNING POST-BUILD HOST CHECKS" $colour_blue

for c in "${checks_list_post[@]}"; do
  if [[ "$c" =~ :$ ]]; then
    printf "\n${colour_blue}$c${colour_nc}\n"
  else
    handle_requirement "$c" 1
    if [ $? -ne 0 ]; then
      exit 1
    fi
  fi
done

# PART 5: Installing requested BenchBot Add-ons
printf "\n"
header_block "PART 5: INSTALLING BENCHBOT ADD-ONS" $colour_blue

install_addons "$addons"

# We are finally done...
echo -e "Finished!"
